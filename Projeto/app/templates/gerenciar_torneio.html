<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciar Torneio - {{ torneio.nome }}</title>
    <link rel="shortcut icon" href="./static/imagens/logoCL.png" type="image/x-icon">  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <style>
        /* Botões de gerenciamento */
.btn-gerenciar-times, .btn-gerenciar-jogadores, .btn-gerenciar-partidas, .btn-editar-torneio, .btn-excluir-torneio {
    padding: 10px 20px;
    border-radius: 12px;
    font-weight: bold;
    text-transform: uppercase;
    color: rgb(2, 201, 45);
    transition: background-color 0.3s ease-in-out, transform 0.3s ease-in-out;
    cursor: pointer;
    border: none;
}

.btn-gerenciar-times {
    background-color: #136db0;
}

.btn-gerenciar-times:hover {
    background-color: #0e5a8f;
    transform: scale(1.05);
}

.btn-gerenciar-jogadores {
    background-color: #11a125;
}

.btn-gerenciar-jogadores:hover {
    background-color: #0a9e05;
    transform: scale(1.05);
}

.btn-gerenciar-partidas {
    background-color: #ff8c00;
}

.btn-gerenciar-partidas:hover {
    background-color: #e07b00;
    transform: scale(1.05);
}

.btn-editar-torneio {
    background-color: #ffc107;
    color: black;
}

.btn-editar-torneio:hover {
    background-color: #e0a800;
    transform: scale(1.05);
}

.btn-excluir-torneio {
    background-color: #dc3545;
}

.btn-excluir-torneio:hover {
    background-color: #c82333;
    transform: scale(1.05);
}

/* Estilo das listas */
.lista-container h3 {
    font-size: 20px;
    color: #136db0;
    margin-bottom: 10px;
}

.list-group {
    max-width: 600px;
}

.list-group-item {
    background-color: #ffffff;
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 10px;
    margin-bottom: 5px;
    transition: background-color 0.3s ease-in-out;
}

.list-group-item:hover {
    background-color: #f1f1f1;
}

/* Estilos para a tabela de times */
.table {
    width: 100%;
    max-width: 800px;
    margin-top: 10px;
    border-collapse: collapse;
    background-color: #ffffff;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.table th, .table td {
    padding: 10px;
    text-align: left;
    vertical-align: middle;
    border: 1px solid #ddd;
}

.table th {
    background-color: #136db0;
    color: white;
    font-weight: bold;
    text-transform: uppercase;
}

.table-striped tbody tr:nth-child(odd) {
    background-color: #f8f9fa;
}

.table-striped tbody tr:hover {
    background-color: #e9ecef;
}

.logo-col {
    width: 50%; /* A tabela define a largura da coluna, ajustável */
    text-align: center;
}

.logo-time {
    width: 50%; /* A imagem ocupa toda a largura da célula */
    height: auto; /* Altura ajustada automaticamente para manter proporção */
    display: block;
    margin: 0 auto; /* Centraliza a imagem */
}
    </style>

</head>
<body>
    <header class="container mt-4">
    </header>

    <div class="container mt-4">
        <!-- Capa e informações do torneio -->
        <div class="torneio-info row">
            <div class="col-md-4">
                <img src="{{ torneio.capa }}" alt="Capa do Torneio" class="torneio-capa img-fluid">
            </div>
            <div class="col-md-8">
                <h2>{{ torneio.nome }}</h2>
                <p><strong>Organizador:</strong> {{ torneio.organizador }}</p>
                <p><strong>Data de Início:</strong> {{ torneio.data_inicio }}</p>
                <p><strong>Formato:</strong> {{ torneio.formato }}</p>
                <p><strong>Descrição:</strong> {{ torneio.descricao }}</p>
            </div>
        </div>

        <!-- Botões de gerenciamento -->
        <div class="mt-4 gerenciar-botoes">
            <button class="btn-gerenciar-times" data-bs-toggle="modal" data-bs-target="#modalTimes">Gerenciar Times</button>
            <button class="btn-gerenciar-jogadores" data-bs-toggle="modal" data-bs-target="#modalJogadores">Gerenciar Jogadores</button>
            <button class="btn-gerenciar-partidas" data-bs-toggle="modal" data-bs-target="#modalPartidas">Gerenciar Partidas</button>
        </div>

        <!-- Tabela de times -->
        <div class="mt-4 lista-container">
            <h3>Times Cadastrados</h3>
            <table id="tabela-times" class="table table-striped table-bordered">
                <thead>
                    <tr>
                        <th>Logo</th>
                        <th>Nome</th>
                        <th>Lugar</th>
                    </tr>
                </thead>
                <tbody id="corpo-tabela-times"></tbody>
            </table>
        </div>

        <!-- Lista de jogadores -->
        <div class="mt-4 lista-container">
            <h3>Jogadores Cadastrados</h3>
            <ul id="lista-jogadores" class="list-group"></ul>
        </div>
    </div>

    <!-- Modal para Times -->
    <div class="modal fade" id="modalTimes" tabindex="-1" aria-labelledby="modalTimesLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTimesLabel">Gerenciar Times</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="formTime">
                        <div class="mb-3">
                            <label for="timeNome" class="form-label">Nome do Time</label>
                            <input type="text" class="form-control" id="timeNome" required>
                        </div>
                        <div class="mb-3">
                            <label for="timeLugar" class="form-label">Lugar</label>
                            <input type="text" class="form-control" id="timeLugar" required>
                        </div>
                        <div class="mb-3">
                            <label for="timeLogo" class="form-label">Logo do Time</label>
                            <input type="file" class="form-control" id="timeLogo" accept="image/*">
                        </div>
                        <button type="submit" class="btn btn-gerenciar-times">Adicionar Time</button>
                    </form>
                    <h6 class="mt-3">Times Existentes</h6>
                    <table id="tabela-times-modal" class="table table-striped table-bordered">
                        <thead>
                            <tr>
                                <th>Logo</th>
                                <th>Nome</th>
                                <th>Lugar</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="corpo-tabela-times-modal"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Jogadores -->
    <div class="modal fade" id="modalJogadores" tabindex="-1" aria-labelledby="modalJogadoresLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalJogadoresLabel">Gerenciar Jogadores</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="formJogador">
                        <div class="mb-3">
                            <label for="jogadorId" class="form-label">ID do Jogador</label>
                            <input type="number" class="form-control" id="jogadorId" required>
                        </div>
                        <div class="mb-3">
                            <label for="jogadorNome" class="form-label">Nome do Jogador</label>
                            <input type="text" class="form-control" id="jogadorNome" required>
                        </div>
                        <div class="mb-3">
                            <label for="jogadorPosicao" class="form-label">Posição</label>
                            <input type="text" class="form-control" id="jogadorPosicao" required>
                        </div>
                        <div class="mb-3">
                            <label for="jogadorTimeId" class="form-label">ID do Time</label>
                            <input type="number" class="form-control" id="jogadorTimeId" required>
                        </div>
                        <button type="submit" class="btn btn-gerenciar-jogadores">Adicionar Jogador</button>
                    </form>
                    <h6 class="mt-3">Jogadores Existentes</h6>
                    <ul id="lista-jogadores-modal" class="list-group"></ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Partidas -->
    <div class="modal fade" id="modalPartidas" tabindex="-1" aria-labelledby="modalPartidasLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalPartidasLabel">Gerenciar Partidas</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="formPartida">
                        <div class="mb-3">
                            <label for="partidaTime1Id" class="form-label">Time 1 (ID)</label>
                            <input type="number" class="form-control" id="partidaTime1Id" required>
                        </div>
                        <div class="mb-3">
                            <label for="partidaTime2Id" class="form-label">Time 2 (ID)</label>
                            <input type="number" class="form-control" id="partidaTime2Id" required>
                        </div>
                        <div class="mb-3">
                            <label for="partidaData" class="form-label">Data</label>
                            <input type="date" class="form-control" id="partidaData" required>
                        </div>
                        <div class="mb-3">
                            <label for="partidaResultado" class="form-label">Resultado (opcional)</label>
                            <input type="text" class="form-control" id="partidaResultado">
                        </div>
                        <button type="submit" class="btn btn-gerenciar-partidas">Adicionar Partida</button>
                    </form>
                    <h6 class="mt-3">Partidas Existentes</h6>
                    <ul id="lista-partidas-modal" class="list-group"></ul>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const torneioId = "{{ torneio.id }}";

        // Carregar listas na página principal
        function carregarTimes() {
            fetch(`/times/torneio/${torneioId}/`)
                .then(response => {
                    if (!response.ok) throw new Error("Erro ao carregar times");
                    return response.json();
                })
                .then(times => {
                    const corpoTabela = document.getElementById("corpo-tabela-times");
                    corpoTabela.innerHTML = "";
                    times.forEach(time => {
                        const logoImg = time.logo ? `<img src="/static/imagens/times/${time.logo}" alt="Logo do Time" class="logo-time">` : 'Sem logo';
                        corpoTabela.innerHTML += `
                            <tr>
                                <td class="logo-col">${logoImg}</td>
                                <td>${time.nome}</td>
                                <td>${time.lugar}</td>
                            </tr>`;
                    });
                })
                .catch(error => console.error("Erro ao carregar times:", error));
        }

        function carregarJogadores() {
            fetch(`/torneios/${torneioId}/jogadores/`)
                .then(response => {
                    if (!response.ok) throw new Error("Erro ao carregar jogadores");
                    return response.json();
                })
                .then(jogadores => {
                    const lista = document.getElementById("lista-jogadores");
                    lista.innerHTML = "";
                    jogadores.forEach(jogador => {
                        lista.innerHTML += `
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                ${jogador.nome} - ${jogador.posicao}
                            </li>`;
                    });
                })
                .catch(error => console.error("Erro ao carregar jogadores:", error));
        }

        // Carregar listas nos modais
        function carregarTimesModal() {
            fetch(`/times/torneio/${torneioId}/`)
                .then(response => {
                    if (!response.ok) throw new Error("Erro ao carregar times no modal");
                    return response.json();
                })
                .then(times => {
                    const corpoTabelaModal = document.getElementById("corpo-tabela-times-modal");
                    corpoTabelaModal.innerHTML = "";
                    times.forEach(time => {
                        const logoImg = time.logo ? `<img src="/static/imagens/times/${time.logo}" alt="Logo do Time" class="logo-time">` : 'Sem logo';
                        corpoTabelaModal.innerHTML += `
                            <tr>
                                <td class="logo-col">${logoImg}</td>
                                <td>${time.nome}</td>
                                <td>${time.lugar}</td>
                                <td>
                                    <button class="btn btn-sm btn-warning me-2" onclick="editarTime(${time.id})">Editar</button>
                                    <button class="btn btn-sm btn-danger" onclick="deletarTime(${time.id})">Excluir</button>
                                </td>
                            </tr>`;
                    });
                })
                .catch(error => console.error("Erro ao carregar times no modal:", error));
        }

        function carregarJogadoresModal() {
            fetch(`/jogadores/`)
                .then(response => {
                    if (!response.ok) throw new Error("Erro ao carregar jogadores no modal");
                    return response.json();
                })
                .then(jogadores => {
                    const lista = document.getElementById("lista-jogadores-modal");
                    lista.innerHTML = "";
                    jogadores.filter(j => j.time && j.time.torneio_id === parseInt(torneioId)).forEach(jogador => {
                        lista.innerHTML += `
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                ${jogador.nome} - ${jogador.posicao}
                                <div>
                                    <button class="btn btn-sm btn-warning me-2" onclick="editarJogador(${jogador.id})">Editar</button>
                                    <button class="btn btn-sm btn-danger" onclick="deletarJogador(${jogador.id})">Excluir</button>
                                </div>
                            </li>`;
                    });
                })
                .catch(error => console.error("Erro ao carregar jogadores no modal:", error));
        }

        function carregarPartidasModal() {
            fetch(`/partidas/`)
                .then(response => {
                    if (!response.ok) throw new Error("Erro ao carregar partidas no modal");
                    return response.json();
                })
                .then(partidas => {
                    const lista = document.getElementById("lista-partidas-modal");
                    lista.innerHTML = "";
                    partidas.forEach(partida => {
                        lista.innerHTML += `
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                ${partida.time1_nome} vs ${partida.time2_nome} - ${partida.data} (${partida.resultado || 'Sem resultado'})
                                <button class="btn btn-sm btn-danger" onclick="deletarPartida(${partida.id})">Excluir</button>
                            </li>`;
                    });
                })
                .catch(error => console.error("Erro ao carregar partidas no modal:", error));
        }

        // CRUD Times
        document.getElementById("formTime").addEventListener("submit", function(e) {
            e.preventDefault();
            const nome = document.getElementById("timeNome").value;
            const lugar = document.getElementById("timeLugar").value;
            const logo = document.getElementById("timeLogo").files[0];

            const formData = new FormData();
            formData.append("nome", nome);
            formData.append("lugar", lugar);
            formData.append("torneio_id", torneioId);
            if (logo) formData.append("logo", logo);

            fetch("/times/", {
                method: "POST",
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => { throw new Error(JSON.stringify(err)) });
                }
                return response.json();
            })
            .then(data => {
                console.log("Time criado com sucesso:", data);
                carregarTimes();
                carregarTimesModal();
                document.getElementById("timeNome").value = "";
                document.getElementById("timeLugar").value = "";
                document.getElementById("timeLogo").value = "";
            })
            .catch(error => console.error("Erro ao adicionar time:", error));
        });

        function editarTime(id) {
            const nome = prompt("Novo nome do time:");
            const lugar = prompt("Novo lugar do time:");
            const logo = document.createElement("input");
            logo.type = "file";
            logo.accept = "image/*";
            logo.click();

            logo.onchange = function() {
                const formData = new FormData();
                formData.append("nome", nome);
                formData.append("lugar", lugar);
                formData.append("torneio_id", torneioId);
                if (logo.files[0]) formData.append("logo", logo.files[0]);

                fetch(`/times/${id}/`, {
                    method: "PUT",
                    body: formData
                })
                .then(response => {
                    if (!response.ok) throw new Error("Erro ao editar time");
                    carregarTimes();
                    carregarTimesModal();
                })
                .catch(error => console.error("Erro ao editar time:", error));
            };
        }

        function deletarTime(id) {
            if (confirm("Tem certeza que deseja excluir este time?")) {
                fetch(`/times/${id}/`, { method: "DELETE" })
                .then(response => {
                    if (!response.ok) throw new Error("Erro ao deletar time");
                    carregarTimes();
                    carregarTimesModal();
                })
                .catch(error => console.error("Erro ao deletar time:", error));
            }
        }

        // CRUD Jogadores
        document.getElementById("formJogador").addEventListener("submit", function(e) {
            e.preventDefault();
            const id = document.getElementById("jogadorId").value;
            const nome = document.getElementById("jogadorNome").value;
            const posicao = document.getElementById("jogadorPosicao").value;
            const timeId = document.getElementById("jogadorTimeId").value;
            fetch("/jogadores/", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ id, nome, posicao, gols: 0, time_id: timeId })
            })
            .then(response => {
                if (!response.ok) throw new Error("Erro ao adicionar jogador");
                return response.json();
            })
            .then(() => {
                carregarJogadores();
                carregarJogadoresModal();
                document.getElementById("jogadorId").value = "";
                document.getElementById("jogadorNome").value = "";
                document.getElementById("jogadorPosicao").value = "";
                document.getElementById("jogadorTimeId").value = "";
            })
            .catch(error => console.error("Erro ao adicionar jogador:", error));
        });

        function editarJogador(id) {
            const nome = prompt("Novo nome do jogador:");
            const posicao = prompt("Nova posição do jogador:");
            const timeId = prompt("Novo ID do time:");
            if (nome && posicao && timeId) {
                fetch(`/jogadores/${id}/`, {
                    method: "PUT",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ id, nome, posicao, time_id: timeId })
                })
                .then(response => {
                    if (!response.ok) throw new Error("Erro ao editar jogador");
                    carregarJogadores();
                    carregarJogadoresModal();
                })
                .catch(error => console.error("Erro ao editar jogador:", error));
            }
        }

        function deletarJogador(id) {
            if (confirm("Tem certeza que deseja excluir este jogador?")) {
                fetch(`/jogadores/${id}/`, { method: "DELETE" })
                .then(response => {
                    if (!response.ok) throw new Error("Erro ao deletar jogador");
                    carregarJogadores();
                    carregarJogadoresModal();
                })
                .catch(error => console.error("Erro ao deletar jogador:", error));
            }
        }

        // CRUD Partidas
        document.getElementById("formPartida").addEventListener("submit", function(e) {
            e.preventDefault();
            const time1Id = document.getElementById("partidaTime1Id").value;
            const time2Id = document.getElementById("partidaTime2Id").value;
            const data = document.getElementById("partidaData").value;
            const resultado = document.getElementById("partidaResultado").value || null;
            fetch("/partidas/", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ time1_id: time1Id, time2_id: time2Id, data, resultado })
            })
            .then(response => {
                if (!response.ok) throw new Error("Erro ao adicionar partida");
                return response.json();
            })
            .then(() => {
                carregarPartidasModal();
                document.getElementById("partidaTime1Id").value = "";
                document.getElementById("partidaTime2Id").value = "";
                document.getElementById("partidaData").value = "";
                document.getElementById("partidaResultado").value = "";
            })
            .catch(error => console.error("Erro ao adicionar partida:", error));
        });

        function deletarPartida(id) {
            if (confirm("Tem certeza que deseja excluir esta partida?")) {
                fetch(`/partidas/${id}/`, { method: "DELETE" })
                .then(response => {
                    if (!response.ok) throw new Error("Erro ao deletar partida");
                    carregarPartidasModal();
                })
                .catch(error => console.error("Erro ao deletar partida:", error));
            }
        }

        // Carregar dados ao abrir a página e os modais
        document.addEventListener("DOMContentLoaded", () => {
            carregarTimes();
            carregarJogadores();
        });

        document.getElementById("modalTimes").addEventListener("shown.bs.modal", carregarTimesModal);
        document.getElementById("modalJogadores").addEventListener("shown.bs.modal", carregarJogadoresModal);
        document.getElementById("modalPartidas").addEventListener("shown.bs.modal", carregarPartidasModal);
    </script>
</body>
</html>