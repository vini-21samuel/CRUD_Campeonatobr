<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciar Torneio - {{ torneio.nome }}</title>
    <link rel="shortcut icon" href="./static/imagens/logoCL.png" type="image/x-icon">  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <style>
        /* Botões de gerenciamento */
        .btn-gerenciar-times, .btn-gerenciar-jogadores, .btn-gerenciar-partidas, .btn-editar-torneio, .btn-excluir-torneio {
            padding: 10px 20px;
            border-radius: 12px;
            font-weight: bold;
            text-transform: uppercase;
            color: white;
            transition: background-color 0.3s ease-in-out, transform 0.3s ease-in-out;
            cursor: pointer;
            border: none;
            display: inline-block;
        }

        .btn-gerenciar-times { background-color: #136db0; }
        .btn-gerenciar-times:hover { background-color: #0e5a8f; transform: translateY(-5px); }
        .btn-gerenciar-jogadores { background-color: #11a125; }
        .btn-gerenciar-jogadores:hover { background-color: #0a9e05; transform: translateY(-5px); }
        .btn-gerenciar-partidas { background-color: #ff8c00; }
        .btn-gerenciar-partidas:hover { background-color: #e07b00; transform: translateY(-5px); }
        .btn-editar-torneio { background-color: #ffc107; color: black; }
        .btn-editar-torneio:hover { background-color: #e0a800; transform: translateY(-5px); }
        .btn-excluir-torneio { background-color: #dc3545; color: white; }
        .btn-excluir-torneio:hover { background-color: #c82333; transform: translateY(-5px); }

        /* Estilo das listas */
        .lista-container h3 {
            font-size: 20px;
            color: #136db0;
            margin-bottom: 10px;
        }

        .list-group { max-width: 600px; }
        .list-group-item {
            background-color: #ffffff;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 5px;
            transition: background-color 0.3s ease-in-out;
        }
        .list-group-item:hover { background-color: #f1f1f1; }

        /* Estilos para a tabela de times */
        .table {
            width: 100%;
            max-width: 800px;
            margin-top: 10px;
            border-collapse: collapse;
            background-color: #ffffff;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .table th, .table td {
            padding: 10px;
            text-align: left;
            vertical-align: middle;
            border: 1px solid #ddd;
        }

        .table th {
            background-color: #136db0;
            color: white;
            font-weight: bold;
            text-transform: uppercase;
        }

        .table-striped tbody tr:nth-child(odd) { background-color: #f8f9fa; }
        .table-striped tbody tr:hover { background-color: #e9ecef; }
        .logo-col { width: 75px; text-align: center; }
        .logo-time {
            width: 60px;
            height: 50px;
            object-fit: contain;
            display: block;
            margin: 0 auto;
        }
    </style>
</head>
<body>
    <header class="container mt-4"></header>

    <div class="container mt-4">
        <!-- Capa e informações do torneio -->
        <div class="torneio-info row">
            <div class="col-md-4">
                <img src="{{ torneio.capa }}" alt="Capa do Torneio" class="torneio-capa img-fluid">
            </div>
            <div class="col-md-8">
                <h2>{{ torneio.nome }}</h2>
                <p><strong>Organizador:</strong> {{ torneio.organizador }}</p>
                <p><strong>Data de Início:</strong> {{ torneio.data_inicio }}</p>
                <p><strong>Formato:</strong> {{ torneio.formato }}</p>
                <p><strong>Descrição:</strong> {{ torneio.descricao }}</p>
            </div>
        </div>

        <!-- Botões de gerenciamento -->
        <div class="mt-4 gerenciar-botoes">
            <button class="btn-gerenciar-times" data-bs-toggle="modal" data-bs-target="#modalTimes">Gerenciar Times</button>
            <button class="btn-gerenciar-jogadores" data-bs-toggle="modal" data-bs-target="#modalJogadores">Gerenciar Jogadores</button>
            <button class="btn-gerenciar-partidas" data-bs-toggle="modal" data-bs-target="#modalPartidas">Gerenciar Partidas</button>
        </div>

        <!-- Tabela de times -->
        <div class="mt-4 lista-container">
            <h3>Times Cadastrados</h3>
            <table id="tabela-times" class="table table-striped table-bordered">
                <thead>
                    <tr>
                        <th>Logo</th>
                        <th>Nome</th>
                        <th>Lugar</th>
                    </tr>
                </thead>
                <tbody id="corpo-tabela-times"></tbody>
            </table>
        </div>

        <!-- Lista de jogadores -->
        <div class="mt-4 lista-container">
            <h3>Jogadores Cadastrados</h3>
            <ul id="lista-jogadores" class="list-group"></ul>
        </div>
    </div>

    <!-- Modal para Times -->
    <div class="modal fade" id="modalTimes" tabindex="-1" aria-labelledby="modalTimesLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTimesLabel">Gerenciar Times</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="formTime">
                        <div class="mb-3">
                            <label for="timeNome" class="form-label">Nome do Time</label>
                            <input type="text" class="form-control" id="timeNome" required>
                        </div>
                        <div class="mb-3">
                            <label for="timeLugar" class="form-label">Lugar</label>
                            <input type="text" class="form-control" id="timeLugar" required>
                        </div>
                        <div class="mb-3">
                            <label for="timeLogo" class="form-label">Logo do Time</label>
                            <input type="file" class="form-control" id="timeLogo" accept="image/*">
                        </div>
                        <button type="submit" class="btn btn-gerenciar-times">Adicionar Time</button>
                    </form>
                    <h6 class="mt-3">Times Existentes</h6>
                    <table id="tabela-times-modal" class="table table-striped table-bordered">
                        <thead>
                            <tr>
                                <th>Logo</th>
                                <th>Nome</th>
                                <th>Lugar</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="corpo-tabela-times-modal"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Jogadores -->
    <div class="modal fade" id="modalJogadores" tabindex="-1" aria-labelledby="modalJogadoresLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalJogadoresLabel">Gerenciar Jogadores</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="formJogador">
                        <div class="mb-3">
                            <label for="jogadorId" class="form-label">ID do Jogador</label>
                            <input type="number" class="form-control" id="jogadorId" required>
                        </div>
                        <div class="mb-3">
                            <label for="jogadorNome" class="form-label">Nome do Jogador</label>
                            <input type="text" class="form-control" id="jogadorNome" required>
                        </div>
                        <div class="mb-3">
                            <label for="jogadorPosicao" class="form-label">Posição</label>
                            <input type="text" class="form-control" id="jogadorPosicao" required>
                        </div>
                        <div class="mb-3">
                            <label for="jogadorTimeId" class="form-label">Time</label>
                            <select class="form-control" id="jogadorTimeId" required>
                                <option value="">Selecione um time</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-gerenciar-jogadores">Adicionar Jogador</button>
                    </form>
                    <h6 class="mt-3">Jogadores Existentes</h6>
                    <ul id="lista-jogadores-modal" class="list-group"></ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Partidas -->
    <div class="modal fade" id="modalPartidas" tabindex="-1" aria-labelledby="modalPartidasLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalPartidasLabel">Gerenciar Partidas</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="formPartida">
                        <div class="mb-3">
                            <label for="partidaTime1Id" class="form-label">Time 1</label>
                            <select class="form-select" id="partidaTime1Id" required></select>
                        </div>
                        <div class="mb-3">
                            <label for="partidaTime2Id" class="form-label">Time 2</label>
                            <select class="form-select" id="partidaTime2Id" required></select>
                        </div>
                        <div class="mb-3">
                            <label for="partidaData" class="form-label">Data</label>
                            <input type="date" class="form-control" id="partidaData" required>
                        </div>
                        <div class="mb-3">
                            <label for="partidaResultado" class="form-label">Resultado (opcional)</label>
                            <input type="text" class="form-control" id="partidaResultado">
                        </div>
                        <button type="submit" class="btn btn-gerenciar-partidas" id="btnSalvarPartida">Adicionar Partida</button>
                    </form>
                    <h6 class="mt-3">Partidas Existentes</h6>
                    <ul id="lista-partidas-modal" class="list-group"></ul>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const torneioId = "{{ torneio.id }}";

        // Função para carregar times no select do formulário de jogadores
        function carregarTimesNoSelect() {
            fetch(`/times/torneio/${torneioId}/`)
                .then(response => {
                    if (!response.ok) throw new Error("Erro ao carregar times");
                    return response.json();
                })
                .then(times => {
                    const select = document.getElementById("jogadorTimeId");
                    select.innerHTML = '<option value="">Selecione um time</option>';
                    times.forEach(time => {
                        select.innerHTML += `<option value="${time.id}">${time.nome}</option>`;
                    });
                })
                .catch(error => console.error("Erro ao carregar times no select:", error));
        }

        // Carregar listas na página principal
        function carregarTimes() {
            fetch(`/times/torneio/${torneioId}/`)
                .then(response => {
                    if (!response.ok) throw new Error("Erro ao carregar times");
                    return response.json();
                })
                .then(times => {
                    const corpoTabela = document.getElementById("corpo-tabela-times");
                    corpoTabela.innerHTML = "";
                    times.forEach(time => {
                        const logoImg = time.logo ? `<img src="/static/imagens/times/${time.logo}" alt="Logo do Time" class="logo-time">` : 'Sem logo';
                        corpoTabela.innerHTML += `
                            <tr>
                                <td class="logo-col">${logoImg}</td>
                                <td>${time.nome}</td>
                                <td>${time.lugar}</td>
                            </tr>`;
                    });
                })
                .catch(error => console.error("Erro ao carregar times:", error));
        }

        function carregarJogadores() {
            fetch("/jogadores/")
                .then(response => {
                    if (!response.ok) throw new Error("Erro ao carregar jogadores");
                    return response.json();
                })
                .then(jogadores => {
                    const lista = document.getElementById("lista-jogadores");
                    lista.innerHTML = "";
                    jogadores.forEach(jogador => {
                        lista.innerHTML += `
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                ${jogador.nome} - ${jogador.posicao} (Gols: ${jogador.gols}) - Time: ${jogador.time.nome}
                                <div>
                                    <button class="btn btn-sm btn-warning me-2" onclick="abrirModalEditarJogador(${jogador.id}, '${jogador.nome}', '${jogador.posicao}', ${jogador.time.id})">Editar</button>
                                    <button class="btn btn-sm btn-danger" onclick="deletarJogador(${jogador.id})">Excluir</button>
                                </div>
                            </li>`;
                    });
                })
                .catch(error => console.error("Erro ao carregar jogadores:", error));
        }

        // Carregar listas nos modais
        function carregarTimesModal() {
            fetch(`/times/torneio/${torneioId}/`)
                .then(response => {
                    if (!response.ok) throw new Error("Erro ao carregar times no modal");
                    return response.json();
                })
                .then(times => {
                    const corpoTabelaModal = document.getElementById("corpo-tabela-times-modal");
                    corpoTabelaModal.innerHTML = "";
                    times.forEach(time => {
                        const logoImg = time.logo ? `<img src="/static/imagens/times/${time.logo}" alt="Logo do Time" class="logo-time">` : 'Sem logo';
                        corpoTabelaModal.innerHTML += `
                            <tr>
                                <td class="logo-col">${logoImg}</td>
                                <td>${time.nome}</td>
                                <td>${time.lugar}</td>
                                <td>
                                    <button class="btn btn-sm btn-warning me-2" onclick="editarTime(${time.id})">Editar</button>
                                    <button class="btn btn-sm btn-danger" onclick="deletarTime(${time.id})">Excluir</button>
                                </td>
                            </tr>`;
                    });
                })
                .catch(error => console.error("Erro ao carregar times no modal:", error));
        }

        function carregarJogadoresModal() {
            fetch(`/jogadores/`)
                .then(response => {
                    if (!response.ok) throw new Error("Erro ao carregar jogadores no modal");
                    return response.json();
                })
                .then(jogadores => {
                    const lista = document.getElementById("lista-jogadores-modal");
                    lista.innerHTML = "";
                    jogadores.filter(j => j.time && j.time.torneio_id === parseInt(torneioId)).forEach(jogador => {
                        const timeNome = jogador.time ? jogador.time.nome : "Sem time";
                        lista.innerHTML += `
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                ${jogador.nome} - ${jogador.posicao} (Time: ${timeNome})
                                <div>
                                    <button class="btn btn-sm btn-warning me-2" onclick="editarJogador(${jogador.id})">Editar</button>
                                    <button class="btn btn-sm btn-danger" onclick="deletarJogador(${jogador.id})">Excluir</button>
                                </div>
                            </li>`;
                    });
                })
                .catch(error => console.error("Erro ao carregar jogadores no modal:", error));
        }

        function carregarPartidasModal() {
            fetch(`/partidas/`)
                .then(response => response.json())
                .then(partidas => {
                    const lista = document.getElementById("lista-partidas-modal");
                    lista.innerHTML = "";
                    partidas.forEach(partida => {
                        lista.innerHTML += `
                            <li class="list-group-item">
                                <div><strong>${partida.time1_nome}</strong> vs <strong>${partida.time2_nome}</strong> - ${partida.data}</div>
                                <div>Resultado: ${partida.resultado || 'Sem resultado'}</div>
                                <button class="btn btn-sm btn-warning mt-1 me-1" onclick="editarPartida(${partida.id})">Editar</button>
                                <button class="btn btn-sm btn-danger mt-1" onclick="deletarPartida(${partida.id})">Excluir</button>
                            </li>`;
                    });
                })
                .catch(error => console.error("Erro ao carregar partidas no modal:", error));
        }

        // Função para carregar times nos selects do modal de partidas
        function carregarTimesSelect() {
            fetch('/times/')
                .then(response => response.json())
                .then(times => {
                    const select1 = document.getElementById("partidaTime1Id");
                    const select2 = document.getElementById("partidaTime2Id");
                    select1.innerHTML = '<option value="">Selecione o Time 1</option>';
                    select2.innerHTML = '<option value="">Selecione o Time 2</option>';
                    times.forEach(time => {
                        const option = document.createElement("option");
                        option.value = time.id;
                        option.text = time.nome;
                        select1.appendChild(option);
                        select2.appendChild(option.cloneNode(true));
                    });
                })
                .catch(error => console.error("Erro ao carregar times:", error));
        }

        // CRUD Times
        document.getElementById("formTime").addEventListener("submit", function(e) {
            e.preventDefault();
            const nome = document.getElementById("timeNome").value;
            const lugar = document.getElementById("timeLugar").value;
            const logo = document.getElementById("timeLogo").files[0];

            const formData = new FormData();
            formData.append("nome", nome);
            formData.append("lugar", lugar);
            formData.append("torneio_id", torneioId);
            if (logo) formData.append("logo", logo);

            fetch("/times/", {
                method: "POST",
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => { throw new Error(JSON.stringify(err)) });
                }
                return response.json();
            })
            .then(data => {
                console.log("Time criado com sucesso:", data);
                carregarTimes();
                carregarTimesModal();
                carregarTimesNoSelect();
                document.getElementById("timeNome").value = "";
                document.getElementById("timeLugar").value = "";
                document.getElementById("timeLogo").value = "";
            })
            .catch(error => console.error("Erro ao adicionar time:", error));
        });

        function editarTime(id) {
            const nome = prompt("Novo nome do time:");
            const lugar = prompt("Novo lugar do time:");
            const logo = document.createElement("input");
            logo.type = "file";
            logo.accept = "image/*";
            logo.click();

            logo.onchange = function() {
                const formData = new FormData();
                formData.append("nome", nome);
                formData.append("lugar", lugar);
                formData.append("torneio_id", torneioId);
                if (logo.files[0]) formData.append("logo", logo.files[0]);

                fetch(`/times/${id}/`, {
                    method: "PUT",
                    body: formData
                })
                .then(response => {
                    if (!response.ok) throw new Error("Erro ao editar time");
                    carregarTimes();
                    carregarTimesModal();
                    carregarTimesNoSelect();
                })
                .catch(error => console.error("Erro ao editar time:", error));
            };
        }

        function deletarTime(id) {
            if (confirm("Tem certeza que deseja excluir este time?")) {
                fetch(`/times/${id}/`, { method: "DELETE" })
                .then(response => {
                    if (!response.ok) throw new Error("Erro ao deletar time");
                    carregarTimes();
                    carregarTimesModal();
                    carregarTimesNoSelect();
                })
                .catch(error => console.error("Erro ao deletar time:", error));
            }
        }

        // CRUD Jogadores
        document.getElementById("formJogador").addEventListener("submit", function(e) {
            e.preventDefault();
            const id = document.getElementById("jogadorId").value;
            const nome = document.getElementById("jogadorNome").value;
            const posicao = document.getElementById("jogadorPosicao").value;
            const timeId = document.getElementById("jogadorTimeId").value;

            fetch("/jogadores/", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ id, nome, posicao, gols: 0, time_id: parseInt(timeId) })
            })
            .then(response => {
                if (!response.ok) throw new Error("Erro ao adicionar jogador");
                return response.json();
            })
            .then(() => {
                carregarJogadores();
                carregarJogadoresModal();
                document.getElementById("jogadorId").value = "";
                document.getElementById("jogadorNome").value = "";
                document.getElementById("jogadorPosicao").value = "";
                document.getElementById("jogadorTimeId").value = "";
            })
            .catch(error => console.error("Erro ao adicionar jogador:", error));
        });

        function editarJogador(id) {
            const nome = prompt("Novo nome do jogador:");
            const posicao = prompt("Nova posição do jogador:");
            const timeId = prompt("Novo ID do time:");
            if (nome && posicao && timeId) {
                fetch(`/jogadores/${id}/`, {
                    method: "PUT",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ id, nome, posicao, time_id: parseInt(timeId) })
                })
                .then(response => {
                    if (!response.ok) throw new Error("Erro ao editar jogador");
                    carregarJogadores();
                    carregarJogadoresModal();
                })
                .catch(error => console.error("Erro ao editar jogador:", error));
            }
        }

        function deletarJogador(id) {
            if (confirm("Tem certeza que deseja excluir este jogador?")) {
                fetch(`/jogadores/${id}/`, { method: "DELETE" })
                .then(response => {
                    if (!response.ok) throw new Error("Erro ao deletar jogador");
                    carregarJogadores();
                    carregarJogadoresModal();
                })
                .catch(error => console.error("Erro ao deletar jogador:", error));
            }
        }

        // CRUD Partidas
        let partidaEmEdicao = null;

        document.getElementById("formPartida").addEventListener("submit", function(e) {
            e.preventDefault();

            const time1Id = document.getElementById("partidaTime1Id").value;
            const time2Id = document.getElementById("partidaTime2Id").value;
            const data = document.getElementById("partidaData").value;
            const resultado = document.getElementById("partidaResultado").value || null;

            const partidaData = {
                time1_id: parseInt(time1Id),
                time2_id: parseInt(time2Id),
                data,
                resultado
            };

            const url = partidaEmEdicao ? `/partidas/${partidaEmEdicao}/` : "/partidas/";
            const method = partidaEmEdicao ? "PUT" : "POST";

            fetch(url, {
                method: method,
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(partidaData)
            })
            .then(response => {
                if (!response.ok) throw new Error("Erro ao salvar partida");
                return response.json();
            })
            .then(() => {
                carregarPartidasModal();
                resetarFormularioPartida();
            })
            .catch(error => console.error("Erro ao salvar partida:", error));
        });

        function editarPartida(id) {
            fetch(`/partidas/${id}`)
                .then(response => {
                    if (!response.ok) throw new Error("Erro ao carregar partida");
                    return response.json();
                })
                .then(partida => {
                    partidaEmEdicao = id;
                    document.getElementById("partidaTime1Id").value = partida.time1_id;
                    document.getElementById("partidaTime2Id").value = partida.time2_id;
                    document.getElementById("partidaData").value = partida.data;
                    document.getElementById("partidaResultado").value = partida.resultado || "";
                    document.getElementById("btnSalvarPartida").textContent = "Salvar Alterações";

                    const modal = new bootstrap.Modal(document.getElementById("modalPartidas"));
                    if (!modal._isShown) modal.show();
                })
                .catch(error => console.error("Erro ao carregar partida para edição:", error));
        }

        function deletarPartida(id) {
            if (confirm("Tem certeza que deseja excluir esta partida?")) {
                fetch(`/partidas/${id}/`, { method: "DELETE" })
                .then(response => {
                    if (!response.ok) throw new Error("Erro ao deletar partida");
                    carregarPartidasModal();
                })
                .catch(error => console.error("Erro ao deletar partida:", error));
            }
        }

        function resetarFormularioPartida() {
            document.getElementById("formPartida").reset();
            document.getElementById("btnSalvarPartida").textContent = "Adicionar Partida";
            partidaEmEdicao = null;
            carregarTimesSelect();
        }

        // Função para abrir modal de edição de jogador (usada na lista principal)
        function abrirModalEditarJogador(id, nome, posicao, timeId) {
            document.getElementById("jogadorId").value = id;
            document.getElementById("jogadorNome").value = nome;
            document.getElementById("jogadorPosicao").value = posicao;
            document.getElementById("jogadorTimeId").value = timeId;
            const modal = new bootstrap.Modal(document.getElementById("modalJogadores"));
            modal.show();
        }

        // Carregar dados ao abrir a página e os modais
        document.addEventListener("DOMContentLoaded", () => {
            carregarTimes();
            carregarJogadores();
        });

        document.getElementById("modalTimes").addEventListener("shown.bs.modal", carregarTimesModal);
        document.getElementById("modalJogadores").addEventListener("shown.bs.modal", () => {
            carregarJogadoresModal();
            carregarTimesNoSelect();
        });
        document.getElementById("modalPartidas").addEventListener("shown.bs.modal", () => {
            carregarTimesSelect();
            carregarPartidasModal();
        });
        document.getElementById("modalPartidas").addEventListener("hidden.bs.modal", resetarFormularioPartida);
    </script>
</body>
</html>